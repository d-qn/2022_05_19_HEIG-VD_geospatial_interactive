---
title: "Tidy geospatial"
author: "Duc-Quang Nguyen"
date: "5/14/2022"
output: 
  html_document:
    code_folding: hide
    echo: TRUE
    warning: FALSE
    message: FALSE
    toc: yes
    toc_depth: 3
    toc_float: true
    theme: simplex
---

## Ressources

### [Geocomputation with R by Robin Lovelace](https://geocompr.robinlovelace.net/index.html)


* Simple features

![ Simple feature types fully supported by sf.](https://geocompr.robinlovelace.net/figures/sf-classes.png)

*sf* can represent all common vector geometry types (raster data classes are not supported by sf): points, lines, polygons and their respective ‘multi’ versions (which group together features of the same type into a single feature). sf also supports geometry collections, which can contain multiple geometry types in a single object.

* [Coordinate reference system CRS](https://geocompr.robinlovelace.net/spatial-class.html#crs-intro) 
How the spatial elements of the data relate to the surface of the Earth

  That coordinate systems are a key component of geographic objects
  * Knowing which CRS your data is in, and whether it is in geographic (lon/lat) or projected (typically meters), is important and has consequences for how R handles spatial and geometry operations
  * CRSs of sf objects can be queried with the function st_crs()

## Carte choroplèthe par municipalité

```{r load packages, echo = F}
library(tidyverse)
library(sf)
```

```{r load Switzerland administrive boundaries}
muni <- st_read("shp/g2g22.shp")

# 
str(muni)


# Quickly see the geodata
select(muni) %>% plot

# Otherwise it will color the map by the features
#plot(muni)

# ggpplot2 
ggplot(muni) +
  geom_sf()


# ggpplot2 
ggplot(muni) +
  geom_sf()


```




















# Carte d'une ville


Données géographiques d'OpenStreetMap en utilisant l'API [overpass](https://wiki.openstreetmap.org/wiki/Overpass_API) 

* Overpass query: Défini la zone géographique qui nous intéresse: bbox


```{r Artymap Yverdon}
library(osmdata) # to get openstreetmap geo data

# settings
bb <- getbb('Yverdon, Switzerland') # define the bbox, will be used to fetch OSM data within that box
dest_proj <- 2056


# OSM overpass query
q <- opq(bbox = bb)

## Get OSM geo data, reproject and discard unused features
q_bg <- q %>% 
  add_osm_feature(key = 'building') %>% 
  osmdata_sf() 

# bind polygons and multipolygons buildings into one data.frame
buildings <- q_bg$osm_polygons %>% 
  st_transform(dest_proj) %>% 
  select(name, osm_id, building) 

buildings <- bind_rows(
  buildings,
  q_bg$osm_multipolygons %>% 
    st_transform(dest_proj) %>% 
    select(name, osm_id, building)
) %>% 
  st_make_valid()

# all roads  
q_rd <- q %>% 
  add_osm_feature(key = 'highway') %>% 
  osmdata_sf() 

# recode roads type to numeric
roads <- q_rd$osm_lines %>% 
  st_transform(dest_proj) %>% 
  select(name, osm_id, highway) %>% 
  mutate(type = case_when(
    highway %in% c("motorway", "motorway_link") ~ 1,
    highway %in% c("primary", "primary_link") ~ 2,
    highway %in% c("secondary", "secondary_link") ~ 3,    
    highway %in% c("tertiary", "tertiary_link") ~ 4,   
    T ~ 5
  ))

# all railway s
q_ry <- q %>% 
  add_osm_feature(key = 'railway')  %>% 
  osmdata_sf()

railways <- q_ry$osm_lines %>% 
  st_transform(dest_proj) %>% 
  select(railway) %>% 
  mutate(type = case_when(
    railway %in% c("rail", "light_rail") ~ 1,
    railway %in% c("subway") ~ 2,
    T ~ 3
  ))

ggplot() +
  geom_sf(data = buildings, 
          fill = "#ECD89DFF",
          size = 0, alpha = 0.25) +
  geom_sf(data = roads, 
          aes(colour = type, size =1/type),
          colour = "white") + 
  geom_sf(data = railways, size = 0.2, 
          colour = "#EEBCB1FF" )+
  scale_size(range =  c(0.03, 0.2)) +
  scale_alpha(range =  c(0.8, 0.98)) +
  theme_void() +
  theme(plot.background = element_rect(fill = "#293133", "293133"),
        legend.position = "none") 

```
        